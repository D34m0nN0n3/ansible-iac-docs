Проект по созданию учетной записи *mpuser* на RHEL/CentOS для сканера безопасности MaxPatrol.
=============================================================================================

Общая концепция
~~~~~~~~~~~~~~~
Данный сценарий выполняет все шаги и действия автоматически описанные в общей концепции.

При сканировании UNIX-системы MP-8 выполняет следующие действия, для которых необходимы привилегии root:

#. Запуск специфичных команд (iptables, lshal, ...)
#. Чтение файлов, обход директорий (cat, grep, find, ...)

.. note:: *Необходимые файлы программы копируются на целевой хост и расположены в папке: files*

Механизм sudo позволяет указать команды (а также их аргументы), которые непривилегированный пользователь сможет выполнять от имени root.
Набор команд, требуемых для сканирования MP-8 в режимах Audit и Compliance, для которых нужны привилегии root, конечен и может быть указан в настройках sudo.
В итоге, только несколько информационных сообщений и контроли, проверяющие содержание переменной $PATH у пользователя root (424664, 434660 и им подобные) будут давать иной вывод, чем при сканировании напрямую от root.

Следовательно, основными задачами при настройках sudo на целевом узле являются следующие:

#. Обеспечение сканирующему пользователю привилегий, с помощью которых будут получены все необходимые данные из системы, по сути в режиме "read-only"
#. Предотвращение возможности модификации данных на системе злоумышленником, владеющим учетной записью сканирующего пользователя.

В дальнейшем будем рассматривать пример, когда учетная запись сканирующего пользователя называется mpuser.
Приведенные настройки относятся к ОС RHEL 7

Настройки целевого узла
~~~~~~~~~~~~~~~~~~~~~~~
Если не оговорено иное, все настройки производятся от имени root.

1. Установить в систему следующие утилиты (сверх минимальной комплектации системы при установке), необходимые для стабильной работы сканера:

``RHEL7:lsof, net-tools``

2. Создать пользователя mpuser, задать ему пароль:

::

    useradd -m -g users mpuser
    passwd mpuser
    chmod 700 /home/mpuser

3. Убедиться, что данный пользователь имеет нужные настройки $PATH и содержимое $HOME:

::

   su - mpuser
   ls -lFd ~/bin 

(должна отобразиться существующая директория /home/mpuser/bin, если ее не существует, то создать ее командой "mkdir ~/bin" от имени mpuser)
    
    ::
    
        echo $PATH
    
(в переменной $PATH должно содержаться /home/mpuser/bin, если этого пути там нет или /home/mpuser/bin стоит не на первом месте - то от имени mpuser изменить в файле     /home/mpuser/.bash_profile строку  
    
    ::
    
        RHEL7:"PATH=$PATH:$HOME/.local/bin:$HOME/bin" на "PATH=$HOME/bin:$PATH:$HOME/.local/bin"
    
также необходимо убедиться в том, что в переменной PATH указан /usr/sbin и /sbin и если один или оба этих пути отсутствуют, то их нужно добавить в переменную $PATH аналогичным способом после $HOME/bin.)

4. От имени mpuser:

   * Закачать прилагаемый архив mpuser_scripts.tar.gz в директорию /home/mpuser
   * Перейти в домашнюю директорию: "cd"
   * Разжать архив командой "tar -xf mpuser_scripts.tar.gz"
   * Переместить содержимое директории sudo_bin в bin: "mv sudo_bin/* bin/"
   * Удалить архив: "rm sudo_bin.tar"
   * Удалить (уже пустую) директорию: "rm -rf sudo_bin/"
   * Сменить права: "chmod -R 700 ~/bin"

.. note:: Таким образом создадутся нужные скрипты-"обертки", имеющие названия системных команд, но расположенные в той директории, путь до которой указан первым в переменной $PATH

5. Внести следующие директивы в файл /etc/sudoers с помощью команды visudo (от имени root):

:: 

    Cmnd_Alias MPROOTCMD = /sbin/fdisk -l, /sbin/fdisk -l [/a-z0-9]*, /sbin/iptables -vnL, /usr/bin/lshal, /usr/sbin/dmidecode, /sbin/iptables-save, /bin/netstat, /usr/sbin/authconfig --test, /sbin/chkconfig --list
    Cmnd_Alias MPFILECMD = /bin/grep, /bin/egrep, /bin/cat, /usr/bin/find *, /bin/ls, /usr/bin/stat, /usr/sbin/lsof, /usr/bin/getfacl, /usr/bin/lsattr
    Cmnd_Alias MPEXCPTNSCMD = !/usr/bin/find *-exec*, !/usr/bin/find *-fprint*, !/usr/bin/find *-ok*
    mpuser ALL = (ALL) NOPASSWD: MPROOTCMD
    mpuser ALL = (ALL) NOPASSWD: MPFILECMD
    mpuser ALL = (ALL) NOPASSWD: MPEXCPTNSCMD

А также убедиться в том, что в этом файле указана директива ``Defaults env_reset`` и в том, что в директиве ``Defaults env_keep`` не указано ``PATH``

.. note:: *Файл с шаблоном правил расположены в папке: templates*

Настройки MaxPatrol 8
~~~~~~~~~~~~~~~~~~~~~
В профиле сканирования, либо в задаче сканирования:

1. Внести учетную запись mpuser с соответствюущим паролем (Профиль сканирования -> Учетные записи -> Режим Audit -> SSH/Telnet)
2. В этом же разделе для опции "Метод повышения привилегий" указать "Не использовать"
3. Выбрать нужный режим сканирования (Audit и/или Compliance)

.. attention::  **SSH ключь передается как шифрованный секрет. Прароль для каждого сервера генерится случайным образом.**

.. hint:: **Для получения пароля от файла с секретом необходимо обратится в отдел УдЦ ГВЦ.**
